<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket 테스트 — AiCupid Backend</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.25rem; }
    section { margin: 1rem 0; }
    label { display: block; margin-bottom: 0.25rem; font-weight: 600; }
    select, button { padding: 0.5rem 0.75rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    button { cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .log { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; max-height: 360px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all; }
    .log .in { color: #9cdcfe; }
    .log .out { color: #ce9178; }
    .log .err { color: #f48771; }
    .log .sys { color: #6a9955; }
    .status { padding: 0.5rem; border-radius: 6px; margin-bottom: 0.5rem; }
    .status.closed { background: #3c1e1e; color: #f48771; }
    .status.open { background: #1e3c1e; color: #4ec9b0; }
    .hint { font-size: 0.85rem; color: #6a737d; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <h1>WebSocket 테스트</h1>
  <p>연결할 엔드포인트를 고르고 <strong>연결</strong> 후 메시지 송수신을 확인하세요.</p>

  <section>
    <label>엔드포인트</label>
    <select id="endpoint">
      <option value="/ws/live">/ws/live — Gemini Live API (음성 스트리밍)</option>
      <option value="/ws/audio">/ws/audio — STT + 퀴즈 + TTS</option>
    </select>
    <div class="hint" id="hint">ws/live: 프론트에서 PCM 16kHz 청크(binary 또는 JSON {"audio":"base64"}) 전송 → 오디오/텍스트 수신</div>
  </section>

  <section>
    <button id="btnConnect">연결</button>
    <button id="btnDisconnect" disabled>연결 끊기</button>
    <div id="status" class="status closed">연결 안 됨</div>
  </section>

  <section>
    <label>수신 로그</label>
    <div id="log" class="log"></div>
  </section>

  <script>
    const endpointSelect = document.getElementById('endpoint');
    const hint = document.getElementById('hint');
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    const hints = {
      '/ws/live': 'ws/live: 프론트에서 PCM 16kHz 청크(binary 또는 JSON {"audio":"base64"}) 전송 → 오디오/텍스트 수신',
      '/ws/audio': 'ws/audio: 바이너리 음성 스트림 전송 → STT → 퀴즈 → TTS 오디오 수신'
    };

    endpointSelect.addEventListener('change', () => {
      hint.textContent = hints[endpointSelect.value] || '';
    });

    let ws = null;

    function log(msg, type = 'sys') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString('ko-KR')}] ${msg}`;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(open) {
      statusEl.textContent = open ? '연결됨' : '연결 안 됨';
      statusEl.className = 'status ' + (open ? 'open' : 'closed');
      btnConnect.disabled = open;
      btnDisconnect.disabled = !open;
    }

    btnConnect.addEventListener('click', () => {
      const path = endpointSelect.value;
      const url = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}${path}`;
      log('연결 시도: ' + url, 'out');
      ws = new WebSocket(url);

      ws.onopen = () => {
        log('연결됨', 'sys');
        setStatus(true);
      };

      ws.onmessage = (ev) => {
        if (typeof ev.data === 'string') {
          try {
            const obj = JSON.parse(ev.data);
            const type = obj.type || 'message';
            if (type === 'audio') log(`[audio] base64 길이: ${(obj.data || '').length}`, 'in');
            else if (type === 'text') log(`[text] ${obj.text || ''}`, 'in');
            else log(ev.data, 'in');
          } catch {
            log(ev.data, 'in');
          }
        } else {
          log(`[binary] ${ev.data.byteLength} bytes`, 'in');
        }
      };

      ws.onerror = (e) => log('오류', 'err');
      ws.onclose = () => {
        log('연결 종료', 'sys');
        setStatus(false);
        ws = null;
      };
    });

    btnDisconnect.addEventListener('click', () => {
      if (ws) {
        ws.close();
        ws = null;
      }
    });
  </script>
</body>
</html>
